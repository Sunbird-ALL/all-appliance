org.ekstep.pluginframework.pluginManager.registerPlugin({"id":"org.ekstep.contenteditorfunctions","ver":"1.2","author":"Sunil A S","description":"","publishedDate":"","editor":{"main":"editor/plugin.js","dependencies":[{"type":"plugin","plugin":"org.ekstep.toaster","ver":"1.0"}]}},org.ekstep.contenteditor.basePlugin.extend({editorState:void 0,telemetryService:org.ekstep.contenteditor.api.getService(ServiceConstants.TELEMETRY_SERVICE),lastSaved:void 0,popUpValues:{},isSaveNotificationPopupOpened:!1,contentService:org.ekstep.contenteditor.api.getService(ServiceConstants.CONTENT_SERVICE),popupService:org.ekstep.contenteditor.api.getService(ServiceConstants.POPUP_SERVICE),conflictdialogOptions:{showPlatformPreview:!1},initialize:function(){var o=this;ecEditor.addEventListener("org.ekstep.editorstate:state",this.setEditorState,this),ecEditor.addEventListener("org.ekstep.contenteditor:save",this.resolveSaveFn,this),ecEditor.addEventListener("org.ekstep.contenteditor:save:meta",this.saveMetadata,this),ecEditor.addEventListener("org.ekstep.contenteditor:preview",function(e,t){o.previewContent(t.fromBeginning)},this),ecEditor.addEventListener("org.ekstep.contenteditor:save:force",this.saveBrowserContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:review",this.reviewContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:publish",this.publishContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:reject",this.rejectContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:acceptFlag",this.acceptContentFlag,this),ecEditor.addEventListener("org.ekstep.contenteditor:discardFlag",this.discardContentFlag,this),ecEditor.addEventListener("org.ekstep.contenteditor:retire",this.retireContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:unlistedPublish",this.unlistedPublishContent,this),ecEditor.addEventListener("org.ekstep.contenteditor:Unauthorized",this.unauthorizedToken,this)},unauthorizedToken:function(){this.popUpValues.headerMsg="Your session has timed out due to inactivity. Please login to resume!",this.popUpValues.popUpIcon="circle remove red",this.popUpValues.showCloseButton=!0,this.popUpValues.unauthorized="unauthorized"},setEditorState:function(e,t){t&&(this.editorState=t)},reviewContent:function(e,o){var t=ecEditor.getContext("contentId");ecEditor.getService(ServiceConstants.CONTENT_SERVICE).sendForReview({contentId:t,channel:ecEditor.getContext("channel")},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content sent for review...",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Sending for review failed, please try again later...",position:"topCenter",icon:"fa fa-warning"}),o&&o(e,t)})},resolveSaveFn:function(e,t){switch(ecEditor.getService(ServiceConstants.CONTENT_SERVICE).getContentMeta(ecEditor.getContext("contentId")).mimeType){case"application/vnd.ekstep.ecml-archive":this.saveContent(e,t),this.conflictdialogOptions.showPlatformPreview=!0;break;case"application/vnd.ekstep.content-collection":this.saveCollectionContent(e,t);break;case"application/vnd.ekstep.html-archive":case"application/vnd.ekstep.h5p-archive":case"application/epub":case"video/mp4":case"application/pdf":case"video/x-youtube":case"video/webm":case"text/x-url":this.saveGenericEditorContent(e,t);break;default:t.callback&&t.callback("unable to resolve save call for the mimetype")}},saveGenericEditorContent:function(e,t){var o=ecEditor._.assign({savingPopup:!0,successPopup:!0,failPopup:!0},t);o.savingPopup&&this.saveNotification("saving"),this._patchContent(t,t.body,o)},saveContent:function(e,t){console.log("Save invoked:",e,t),(t=ecEditor._.assign({savingPopup:!0,successPopup:!0,failPopup:!0,callback:function(){}},t)).savingPopup&&this.saveNotification("saving");var o,e={},i=(t.contentMeta&&(e=t.contentMeta),org.ekstep.pluginframework.eventManager.dispatchEvent("content:before:save"),org.ekstep.contenteditor.stageManager.toECML()),n=("function"==typeof org.ekstep.contenteditor.stageManager.updateStageIcons?e.stageIcons=JSON.stringify(org.ekstep.contenteditor.stageManager.updateStageIcons()):e.stageIcons=JSON.stringify(org.ekstep.contenteditor.stageManager.getStageIcons()),org.ekstep.contenteditor.stageManager.getSummary());n&&(e.totalQuestions=n.totalQuestions,e.totalScore=n.totalScore,o=ecEditor.getService(ServiceConstants.CONTENT_SERVICE).getContentMeta(ecEditor.getContext("contentId")),ecEditor._.isEqual(ecEditor._.map(n.questions,"identifier").sort(),ecEditor._.map(o.questions,"identifier").sort())||(e.questions=n.questions)),e.assets=ecEditor._.compact(org.ekstep.contenteditor.stageManager.assets),e.editorState=JSON.stringify(this.editorState),e.pragma=org.ekstep.contenteditor.stageManager.getPragma(),e.plugins=org.ekstep.contenteditor.stageManager.plugins_used,this._patchContent(e,i,t)},_patchContent:function(e,t,o){var i=this;e=e&&JSON.parse(angular.toJson(e)),this.patchContent(e,t,function(e,t){e?t&&!ecEditor._.isUndefined(t.responseJSON)?"ERR_STALE_VERSION_KEY"==t.responseJSON.params.err?i.showConflictDialog(o):i.changePopupValues("error"):o&&o.failPopup&&(o.savingPopup||i.saveNotification(),i.changePopupValues("error")):t&&(i.changePopupValues("success"),ecEditor.dispatchEvent("org.ekstep.contenteditor:after-save",{})),"function"==typeof o.callback&&o.callback(e,t)},o)},saveBrowserContent:function(t,o){var i=this;this.fetchPlatformContentVersionKey(function(e){i.resolveSaveFn(t,o)})},patchContent:function(o,i,n,a){var s=this;org.ekstep.contenteditor.migration&&org.ekstep.contenteditor.migration.isMigratedContent()?((o=o||{}).oldContentBody=org.ekstep.contenteditor.migration.getBackupContent(),s.showMigratedContentSaveDialog(function(e,t){t&&s.contentService.saveContent(org.ekstep.contenteditor.api.getContext("contentId"),o,i,n),e&&a&&a.callback("save action interrupted by user")})):s.contentService.saveContent(org.ekstep.contenteditor.api.getContext("contentId"),o,i,n)},saveMetadata:function(e,t){this._patchContent(t.contentMeta,void 0,t)},showMigratedContentSaveDialog:function(t){var o=this;this.popupService.open({template:ecEditor.resolvePluginResource(o.manifest.id,o.manifest.ver,"editor/partials/migratedContentSaveMsg.html"),controller:["$scope",function(e){e.saveContent=function(){org.ekstep.contenteditor.migration.clearMigrationFlag(),t(void 0,!0)},e.enableSaveBtn=function(){o.saveBtnEnabled=!0,t(!0,void 0)}}],showClose:!1,closeByDocument:!1,closeByEscape:!1})},saveNotification:function(e){var o=this,t={template:ecEditor.resolvePluginResource(o.manifest.id,o.manifest.ver,"editor/partials/saveMessage.html"),controller:["$scope",function(e){e.popUpValues=o.popUpValues,e.$on("ngDialog.opened",function(e,t){o.isSaveNotificationPopupOpened=!0}),e.unauthorizedUser=function(){"unauthorized"==this.popUpValues.unauthorized&&ecEditor.dispatchEvent("org.ekstep:sunbirdcommonheader:close:editor")}}],showClose:!1,closeByEscape:!1,closeByDocument:!1};console.log("config",t),this.changePopupValues(e),o.isSaveNotificationPopupOpened||this.popupService.open(t,function(){o.isSaveNotificationPopupOpened=!1})},changePopupValues:function(e){"success"===e?(this.popUpValues.headerMsg="Content Saved!",this.popUpValues.popUpIcon="circle check green",this.popUpValues.showCloseButton=!0,this.popUpValues.saveNotificationCloseButton="saveSuccessNotificationCloseButton"):"error"===e&&(this.popUpValues.headerMsg="Failed to save Content",this.popUpValues.popUpIcon="circle remove red",this.popUpValues.showCloseButton=!0,this.popUpValues.saveNotificationCloseButton="saveFailNotificationCloseButton"),"saving"===e&&(this.popUpValues.headerMsg="Saving content please wait...",this.popUpValues.showCloseButton=!1)},showConflictDialog:function(t){var o=this;this.popupService.open({template:ecEditor.resolvePluginResource(o.manifest.id,o.manifest.ver,"editor/partials/conflictDialog.html"),controller:["$scope",function(e){e.showPlatformPreview=!1,o.conflictdialogOptions.showPlatformPreview&&(e.showPlatformPreview=!0),e.previewPlatformContent=function(){o.previewPlatformContent()},e.saveBrowserContent=function(){o.saveBrowserContent(void 0,t),e.closeThisDialog()},e.previewContent=function(){o.previewContent()},e.refreshContent=function(){o.refreshContent()},e.firetelemetry=function(e,t){o.telemetryService.interact({id:"button",type:"click",subtype:"popup",target:t,pluginid:"org.ekstep.contenteditorfunctions",pluginver:"1.2",objectid:e.id,stage:ecEditor.getCurrentStage().id})},e.showAdvancedOption=!1}],className:"ngdialog-theme-plain header-conflict-dialog",showClose:!1,closeByDocument:!0,closeByEscape:!0})},previewContent:function(e){e=!!_.isUndefined(e);org.ekstep.pluginframework.eventManager.dispatchEvent("atpreview:show",{contentBody:org.ekstep.contenteditor.stageManager.toECML(),currentStage:e})},refreshContent:function(){location.reload()},previewPlatformContent:function(){this.fetchPlatformContentBody(function(e){org.ekstep.pluginframework.eventManager.dispatchEvent("atpreview:show",{contentBody:e,currentStage:!0})})},fetchPlatformContentVersionKey:function(o){org.ekstep.contenteditor.api.getService(ServiceConstants.CONTENT_SERVICE).getContentVersionKey(org.ekstep.contenteditor.api.getContext("contentId"),function(e,t){e&&alert("Failed to get updated version key. Please report an issue."),t.versionKey&&o(t)})},fetchPlatformContentBody:function(i){org.ekstep.contenteditor.api.getService(ServiceConstants.CONTENT_SERVICE).getContent(org.ekstep.contenteditor.api.getContext("contentId"),function(e,t){if(e&&alert("Failed to get updated content. Please report an issue."),t&&t.body)try{var o=JSON.parse(t.body);i(o)}catch(e){alert("Failed to parse body from platform. Please report an issue.")}})},publishContent:function(e,o){var t=ecEditor.getContext("contentId");ecEditor.getService(ServiceConstants.CONTENT_SERVICE).publishContent({contentId:t,channel:ecEditor.getContext("channel"),data:o},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content published successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to publish content, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},rejectContent:function(e,o){ecEditor.getService(ServiceConstants.CONTENT_SERVICE).rejectContent({contentId:ecEditor.getContext("contentId"),channel:ecEditor.getContext("channel"),data:o},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content rejected successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to reject content, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},acceptContentFlag:function(e,o){ecEditor.getService(ServiceConstants.CONTENT_SERVICE).acceptContentFlag({contentId:ecEditor.getContext("contentId")},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content flag accepted successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to accept content flag, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},discardContentFlag:function(e,o){ecEditor.getService(ServiceConstants.CONTENT_SERVICE).discardContentFlag({contentId:ecEditor.getContext("contentId")},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content flag discarded successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to discard content flag, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},retireContent:function(e,o){ecEditor.getService(ServiceConstants.CONTENT_SERVICE).retireContent({contentId:ecEditor.getContext("contentId")},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content retired successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to retire content, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},saveCollectionContent:function(e,o){o=o||{};var i=this,n={validNodes:[],invalidNodes:[]},t=ecEditor.getService(ServiceConstants.CONTENT_SERVICE).getContentMeta(ecEditor.getContext("contentId"));t&&t.versionKey&&org.ekstep.collectioneditor.cache.nodesModified[t.identifier]&&org.ekstep.collectioneditor.cache.nodesModified[t.identifier].metadata&&(org.ekstep.collectioneditor.cache.nodesModified[t.identifier].metadata.versionKey=t.versionKey);var a,s=(s=org.ekstep.collectioneditor.api.getService("collection").getCollectionHierarchy())&&JSON.parse(angular.toJson(s));console.log("contentBody",s),a=["name","contentType","mimeType"],ecEditor._.forIn(org.ekstep.collectioneditor.cache.nodesModified,function(t,o){a.forEach(function(e){(t.metadata.hasOwnProperty(e)&&t.metadata[e]?n.validNodes:n.invalidNodes).push(o)})});if(this.lowlightNode(n.validNodes),0<_.size(n.invalidNodes))return o.showNotification&&ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Please update the collection details before save",position:"topCenter",icon:"fa fa-warning"}),this.hightlightNode(n.invalidNodes),o.callback&&o.callback("mandatory fields are missing in the data!"),!1;ecEditor.getService(ServiceConstants.CONTENT_SERVICE).saveCollectionHierarchy({body:s},function(e,t){t&&t.data&&"OK"==t.data.responseCode?(o.showNotification&&ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content saved successfully!",position:"topCenter",icon:"fa fa-check-circle"}),i.highlightNodeForInvalidDialCode(t,s.nodesModified),org.ekstep.collectioneditor.api.getService("collection").clearCache(),ecEditor._.forIn(t.data.result.identifiers,function(e,t){t=ecEditor.getService(ServiceConstants.COLLECTION_SERVICE).getNodeById(t);t&&(t.data.id=e)}),ecEditor.dispatchEvent("meta:after:save",{})):e&&401===t.status&&"Unauthorized"===t.statusText?o.showNotification&&ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Your session has timed out due to inactivity. Please login to resume!",position:"topCenter",icon:"fa fa-warning"}):o.showNotification&&ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to save the content, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})},highlightNodeForInvalidDialCode:function(o,e){var i=this,n=[],t=(ecEditor._.forEach(org.ekstep.services.stateService.state.invaliddialCodeMap,function(e,t){_.has(o.data.result.identifiers,t)?(delete org.ekstep.services.stateService.state.invaliddialCodeMap[t],org.ekstep.services.stateService.setState("invaliddialCodeMap",o.data.result.identifiers[t],e),org.ekstep.services.collectionService.highlightNode(o.data.result.identifiers[t]),i.storeDialCodes(o.data.result.identifiers[t],e)):(i.storeDialCodes(t,e),org.ekstep.services.collectionService.highlightNode(t))}),ecEditor._.forEach(org.ekstep.services.stateService.state.dialCodeMap,function(e,t){_.has(o.data.result.identifiers,t)?(delete org.ekstep.services.stateService.state.dialCodeMap[t],org.ekstep.services.stateService.setState("dialCodeMap",o.data.result.identifiers[t],e),n.push({identifier:o.data.result.identifiers[t],dialcode:e}),org.ekstep.services.collectionService.lowLightNode(o.data.result.identifiers[t]),i.storeDialCodes(o.data.result.identifiers[t],e)):(n.push({identifier:t,dialcode:e}),org.ekstep.services.collectionService.lowLightNode(t),i.storeDialCodes(t,e))}),!1);ecEditor._.forIn(e,function(e){(!e.metadata.dialcodes&&null!==e.metadata.dialcodes||t)&&(e=_.find(n,function(e){return e.identifier===o.data.result.content_id}),_.isUndefined(e))||(t=!0)}),t&&i.dialcodeLink(n)},dialcodeLink:function(e){_.find(e,"dialcode");_.isEmpty(e)?ecEditor._.isEmpty(org.ekstep.services.stateService.state.invaliddialCodeMap)||ecEditor.dispatchEvent("org.ekstep.toaster:warning",{title:"Unable to update some of the QR codes.",position:"topCenter",icon:"fa fa-warning"}):(e={request:{content:e}},ecEditor.getService("dialcode").dialcodeLink(ecEditor.getContext("contentId"),ecEditor.getContext("channel"),e,function(e,t){e?!ecEditor._.isUndefined(e.responseJSON)&&e.responseJSON.params&&"ERR_DIALCODE_LINK"==e.responseJSON.params.err?ecEditor.dispatchEvent("org.ekstep.toaster:error",{title:e.responseJSON.params.errmsg,position:"topCenter",icon:"fa fa-warning"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{title:"QR code(s) updating failed!",position:"topCenter",icon:"fa fa-warning"}):ecEditor._.isEmpty(org.ekstep.services.stateService.state.dialCodeMap)||ecEditor._.isEmpty(org.ekstep.services.stateService.state.invaliddialCodeMap)?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"QR code(s) updated successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:warning",{title:"Unable to update some of the QR codes.",position:"topCenter",icon:"fa fa-warning"})}))},storeDialCodes:function(e,t){e=ecEditor.getService(ServiceConstants.COLLECTION_SERVICE).getNodeById(e);e&&e.data&&(e.data.metadata.dialcodes=t)},hightlightNode:function(e){_.forEach(_.omitBy(_.uniq(e),_.isEmpty),function(e){org.ekstep.services.collectionService.highlightNode(e)})},lowlightNode:function(e){_.forEach(_.omitBy(_.uniq(e),_.isEmpty),function(e){org.ekstep.services.collectionService.lowLightNode(e)})},unlistedPublishContent:function(e,o){var t=ecEditor.getContext("contentId");ecEditor.getService(ServiceConstants.CONTENT_SERVICE).unlistedPublishContent({contentId:t},function(e,t){t&&t.data&&"OK"==t.data.responseCode?ecEditor.dispatchEvent("org.ekstep.toaster:success",{title:"Content limited shared successfully!",position:"topCenter",icon:"fa fa-check-circle"}):ecEditor.dispatchEvent("org.ekstep.toaster:error",{message:"Unable to share content, try again!",position:"topCenter",icon:"fa fa-warning"}),o.callback&&o.callback(e,t)})}}))